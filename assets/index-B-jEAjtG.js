import{u as N,O as S,m as C,n as d,U as a,j as e,P as k,Q as P}from"./index-DxOCyLaC.js";import{P as A}from"./PasswordFormInput-BSLHxu0K.js";import{T}from"./TextFormInput-BiboZlSY.js";import{r as m,h as F,i as z}from"./vendor-DvxF9bYu.js";import{o as L}from"./yup-CBYd5xIv.js";import{u as V}from"./resolvers-feI25x5d.js";const E=()=>{const{saveSession:t,isAuthenticated:i}=N(),[r,o]=m.useState(!1),p=F(),[f]=z(),{urlApi:h}=m.useContext(S),g=C({email:d().email("Veuillez entrer un email valide").required("Veuillez entrer votre email"),password:d().required("Veuillez entrer votre mot de passe")}),{control:x,handleSubmit:b}=V({resolver:L(g),defaultValues:{email:"",password:""}}),w=s=>s?s.role==="main_user"?"/admin/dashboard":s.role==="secondary_user"?"/gestion/dashboard":"/auth/sign-in":"/auth/sign-in",j=b(async s=>{o(!0);try{console.log("Attempting login with:",s.email);const n=await(await fetch(h+"auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s.email,password:s.password})})).json();if(n.error){a.error(n.error,{position:"top-right",duration:3e3}),o(!1);return}const{user_info:v,access_token:y,parent:c}=n;if(!c||c.id===null)return a.error("Vous n'êtes pas encore un responsable dans une entreprise.",{position:"top-right",duration:3e3}),await t(null),o(!1),p("/auth/sign-in");if(!y)throw new Error("Token d'accès non trouvé dans la réponse");if(a.success("Connexion réussie. Redirection...",{position:"top-right",duration:2e3}),console.log("Login successful, saving session..."),!await t(n)){console.error("Failed to save session"),o(!1);return}console.log("Session saved successfully, isAuthenticated:",i);const u=f.get("redirectTo")??w(v);console.log("Redirecting to:",u),setTimeout(()=>{window.location.href=u,o(!1)},100)}catch(l){console.error("Erreur lors de la connexion:",l),a.error("Une erreur s'est produite lors de la connexion.",{position:"top-right",duration:3e3}),o(!1)}});return{loading:r,login:j,control:x}},W=()=>{const{loading:t,login:i,control:r}=E();return e.jsxs(e.Fragment,{children:[e.jsx(k,{title:"Connexion"}),e.jsxs("form",{className:"mt-2 shrink",onSubmit:i,children:[e.jsx(T,{containerClassName:"mb-4",label:"Adresse email",name:"email",labelClassName:"block text-base/normal text-zinc-200 font-semibold",className:"block rounded border-white/10 bg-transparent py-2.5 text-white/80 focus:border-white/25 focus:outline-0 focus:ring-0",fullWidth:!0,control:r}),e.jsx(A,{label:"Mot de passe",containerClassName:"mb-4",name:"password",labelClassName:"block text-base/normal text-zinc-200 font-semibold",fullWidth:!0,className:"block w-full rounded border-white/10 py-2.5 bg-transparent text-white/80 focus:border-white/25 focus:outline-0 focus:ring-0",control:r}),e.jsx("div",{className:"mb-6 flex flex-wrap items-center justify-between gap-x-1 gap-y-2",children:e.jsx("div",{})}),e.jsx("div",{className:"text-center text-sm justify-between ",children:e.jsxs("button",{type:"submit",disabled:t,className:"group mt-5 inline-flex w-2/3 items-center justify-center rounded bg-blueLogo px-6 py-2.5 text-white backdrop-blur-2xl transition-all hover:text-white",children:[t?"Chargement...":"Se connecter",t&&e.jsx(P,{className:"ml-2 animate-spin"})]})})]}),e.jsx("br",{})]})};export{W as default};
